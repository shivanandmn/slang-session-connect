name: Test and Deploy Cloud Function (Gen2)

on:
  push:
    branches: [ "main" ]
    paths:
      - "main.py"
      - "requirements.txt"
      - "requirements-dev.txt"
      - ".github/workflows/deploy-cloud-function.yml"
      - "tests/**"

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Run tests
        run: pytest -q

  deploy:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      FUNCTION_NAME: slang-session-connect
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GCP_REGION: ${{ secrets.GCP_REGION }}
      LIVEKIT_URL: ${{ secrets.LIVEKIT_URL }}
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: ">= 474.0.0"

      - name: Validate required secrets
        run: |
          if [ -z "${LIVEKIT_URL}" ]; then
            echo "LIVEKIT_URL GitHub secret is required but not set." >&2
            exit 1
          fi

      - name: Deploy Cloud Function (Gen2)
        run: |
          gcloud functions deploy "$FUNCTION_NAME" \
            --gen2 \
            --project "$GCP_PROJECT_ID" \
            --region "$GCP_REGION" \
            --runtime python311 \
            --entry-point connection_details \
            --source . \
            --trigger-http \
            --allow-unauthenticated \
            --memory 512Mi \
            --timeout 30s \
            --max-instances 5 \
            --service-account "${GCP_SERVICE_ACCOUNT}" \
            --build-service-account "${GCP_SERVICE_ACCOUNT}" \
            --set-env-vars LIVEKIT_URL="${LIVEKIT_URL}" \
            --set-secrets LIVEKIT_API_KEY=LIVEKIT_API_KEY:latest,LIVEKIT_API_SECRET=LIVEKIT_API_SECRET:latest
